{{ define "title" }} {{getText "panel.admin"}} {{ end }}
{{ define "content" }}

<h1>
	{{getText "panel.admin"}}
</h1>
<button class="btn-blue font-bold py-2 px-4 rounded-lg mt-3 mb-5" onclick="resetSubs()">{{getText "resetSubs"}}</button>

<div class="segment-container">
	<h2>{{getText "changeRoles"}}:</h2>
	<label class="block">
		<span class="form-label">{{getText "username"}}:</span>
		<input class="form-input my-1 block" type="text" id="userToChange" placeholder="AlexVasiluta">
	</label>
	<div class="mt-2 mb-2 inline-flex">
		<button type="button" class="btn-blue font-bold py-2 px-4 rounded-l" onclick="setFormAdmin(true)">{{getText "makeAdmin"}}</button>
		<button type="button" class="btn-blue font-bold py-2 px-4 rounded-r" onclick="setFormProposer(true)">{{getText "makeProposer"}}</button>
	</div>
</div>

<div class="segment-container">
	<h3 class="text-2xl">{{getText "admins"}}:</h3>
	<div id="admin-group" class="block list-group list-group-rounded mb-2">
		<div class="list-group-head">
            {{getText "loading"}}
        </div>
	</div>
	<h3 class="text-2xl">{{getText "proposers"}}:</h3>
	<div id="proposer-group" class="block list-group list-group-rounded mb-2">
		<div class="list-group-head">
            {{getText "loading"}}
        </div>
	</div>
</div>

<script>
	async function resetSubs() {
		let res = await bundled.postCall("/admin/maintenance/resetWaitingSubs", {});
		bundled.apiToast(res)
	}
	async function setAdmin(id, set) {
		let res = await bundled.postCall("/admin/setAdmin", {id, set})
		bundled.apiToast(res)
		if(res.status == "error") {
			return
		}
		loadUsers({admin: true}, "admin-group", "setAdmin");
		loadUsers({proposer: true}, "proposer-group", "setProposer");
	}
	async function setProposer(id, set) {
		let res = await bundled.postCall("/admin/setProposer", {id, set})
		bundled.apiToast(res)
		if(res.status == "error") {
			return
		}
		loadUsers({proposer: true}, "proposer-group", "setProposer");
	}

	async function setFormAdmin(toSet) {
		let user = document.getElementById("userToChange").value;
		let res = await bundled.getCall('/user/getByName', {name: user})
		if(res.status == "error") {
			bundled.apiToast(res)
			return
		}
		await setAdmin(res.data.id, toSet)
	}
	async function setFormProposer(toSet) {
		let user = document.getElementById("userToChange").value;
		let res = await bundled.getCall('/user/getByName', {name: user})
		if(res.status == "error") {
			bundled.apiToast(res)
			return
		}
		await setProposer(res.data.id, toSet)
	}

	async function loadUsers(q, id = "admin-group", cb) {
		document.getElementById(id).innerHTML = `<div class="list-group-head">${bundled.getText("loading")}</div>`
		let res = await bundled.getCall("/admin/getAllUsers", q)
		if(res.status == "error") {
			bundled.apiToast(res)
			return
		}
		let outhtml = ""
		for(let user of res.data.users) {
			outhtml += `<div class="list-group-item flex justify-between items-center"><a href="/profile/${user.name}"><img class="rounded inline-block mr-2" src="/api/user/getGravatar?name=${user.name}&s=32" width="32" height="32" alt="Avatar"/>${user.name}</a>`
			if(user.id != 1 && {{.Ctx.User.ID}} == 1) {
				outhtml += `<span style="cursor: pointer;" onclick="${cb}(${user.id}, false)">X</span>`
			}
			outhtml += `</div>`
		}
		document.getElementById(id).innerHTML = outhtml
	}
	loadUsers({admin: true}, "admin-group", "setAdmin");
	loadUsers({proposer: true}, "proposer-group", "setProposer");
</script>

{{ end }}
