{{ define "title" }} {{ getText "contest_edit" }} {{ end }}
{{ define "content" }}
{{ template "topbar.html" . }}


<div class="page-holder">
    <div class="page-content-full-wrapper">
        <form class="segment-panel" id="contest_update_form" autocomplete="off">
            <h2>{{getText "header.contest.general"}}</h2>
            
            <label class="block mb-2">
                <span class="form-label">{{getText "name"}}: </span>
                <input class="form-input" name="name" type="text" value="{{.Contest.Name}}" required>
            </label>
            <label class="block mb-2">
                <span class="form-label">{{getText "maxSubs"}}: </span>
                <input class="form-input" name="max_subs" type="number" value="{{.Contest.MaxSubs}}" required>
            </label>
            <label class="block mb-2">
                <span class="form-label">{{getText "startTime"}}: </span>
                <input class="form-input" name="start_time" type="text" 
                    pattern="[\d]{4}-[\d]{2}-[\d]{2} [\d]{2}:[\d]{2} [+-][\d]{4}"
                    placeholder="2020-03-18 15:00 +0300" value="{{.Contest.StartTime.Format `2006-01-02 15:04 -0700`}}" required>
            </label>
            <label class="block mb-2">
                <span class="form-label">{{getText "endTime"}}: </span>
                <input class="form-input" name="end_time" type="text" 
                    pattern="[\d]{4}-[\d]{2}-[\d]{2} [\d]{2}:[\d]{2} [+-][\d]{4}"
                    placeholder="2020-03-18 18:00 +0300" value="{{.Contest.EndTime.Format `2006-01-02 15:04 -0700`}}" required>
            </label>
            <div class="block mb-2">
                <label class="inline-flex items-center text-lg">
                    <input class="form-checkbox" id="c_public_join" name="public_join" type="checkbox" {{if .Contest.PublicJoin}}checked{{end}}>
                    <span class="ml-2">{{getText "publicJoin"}}</span>
                </label>
            </div>
            <div class="block mb-2">
                <label class="inline-flex items-center text-lg">
                    <input class="form-checkbox" id="c_reg" name="register_during_contest" type="checkbox" {{if .Contest.RegisterDuringContest}}checked{{end}}>
                    <span class="ml-2">{{getText "register_during_contest"}} 
                        <span class="text-muted"> ({{getText "register_during_contest_warning"}})</span>
                    </span>
                </label>
            </div>
            <div class="block mb-2">
                <label class="inline-flex items-center text-lg">
                    <input class="form-checkbox" id="c_visible" name="visible" type="checkbox" {{if .Contest.Visible}}checked{{end}}>
                    <span class="ml-2">{{getText "visible"}}</span>
                </label>
            </div>
            <div class="block mb-2">
                <label class="inline-flex items-center text-lg">
                    <input class="form-checkbox" id="c_public_leaderboard" name="public_leaderboard" type="checkbox" {{if .Contest.PublicLeaderboard}}checked{{end}}>
                    <span class="ml-2">{{getText "public_leaderboard"}}</span>
                </label>
            </div>
            <label class="block mb-2">
                <span class="form-label">{{getText "per_user_time"}}: </span>
                <input class="form-input" name="per_user_time" type="number" value="{{.Contest.PerUserTime}}" required>
                <span class="form-label">{{getText "seconds"}}</span>
                <p class="text-muted">{{getText "per_user_time_warning"}}</p>
            </label>

            <button class="btn btn-blue" type="submit">{{getText "button.update"}}</button>
            {{if authedUser.Admin}}
            <div class="block my-2">
                <button type="button" id="deleteContestButton" class="btn btn-red mr-2">{{getText "deleteContest"}}</button>
            </div>
            {{end}}
        </form>

        <div class="segment-panel">
            <h2>{{getText "header.contest.edit_problems"}}</h2>
    
            {{$pbs := contestProblems .Ctx.User.Brief .Contest}}
    
            <form class="mb-4" id="contest_problems_form" autocomplete="off">
                <label class="block my-2">
                    <span class="form-label">{{getText "pbs"}}:</span>
                    <input type="text" id="contest_list" class="form-input" pattern="([0-9]+,?)+" value="{{$pbs | problemIDs | intList}}">
                </label>
                <button class="btn btn-blue" type="submit">{{getText "button.update"}}</button>
            </form>
        </div>

        <div class="segment-panel">
            <h2>{{getText "header.contest.access_control"}}</h2>

            <h3>{{getText "editors"}}:</h3>
            <div id="editors_list" class="list-group list-group-rounded mb-2">
                <div class="list-group-head">
                    {{getText "loading"}}
                </div>
            </div>
            <h3>{{getText "testers"}}:</h3>
            <div id="testers_list" class="list-group list-group-rounded mb-2">
                <div class="list-group-head">
                    {{getText "loading"}}
                </div>
            </div>

            <div class="segment-panel">
                <h2>{{getText "add_user"}}</h2>
                <label class="block">
                    <span class="form-label">{{getText "username"}}:</span>
                    <input class="form-input my-1 block" type="text" id="userToAdd" placeholder="AlexVasiluta" autocomplete="off">
                </label>
                <div class="mt-2 mb-2 inline-flex">
                    <button type="button" class="btn-blue font-bold py-2 px-4 rounded-l" onclick="addEditor()">{{getText "add_editor"}}</button>
                    <button type="button" class="btn-blue font-bold py-2 px-4 rounded-r" onclick="addTester()">{{getText "add_tester"}}</button>
                </div>
            </div>
        </div>

        <form class="segment-panel" id="contest_description_form" autocomplete="off">
            <h2 class="inline-block mb-2">{{getText "header.edit.description"}}</h2>
            
            <div class="mb-2">
                <textarea id="contestDesc">{{.Contest.Description}}</textarea>
            </div>
            <div class="mb-2">
                <button class="btn btn-blue">{{getText "button.update"}}</button>
            </div>
        </form>

    </div>
</div>

<style>
    .CodeMirror {
        min-height: 250px;
    }
</style>

<script>
// Contest update-specific stuff
const contest_id = {{.Contest.ID}};
async function updateContest(e) {
    e.preventDefault();
    try {
        var fd = new FormData(e.currentTarget)
        var data = {
            name: fd.get("name"),
            max_subs: fd.get("max_subs"),
            public_join: document.getElementById("c_public_join").checked,
            visible: document.getElementById("c_visible").checked,
            public_leaderboard: document.getElementById("c_public_leaderboard").checked,
            start_time: bundled.contestToNetworkDate(fd.get("start_time")),
            end_time: bundled.contestToNetworkDate(fd.get("end_time")),
            
            per_user_time: fd.get("per_user_time"),
            register_during_contest: document.getElementById("c_reg").checked,
        }
        console.log(fd, data)
    } catch(e) {
        bundled.apiToast({status: "error", data: e.toString()});
        return
    }

    const res = await bundled.postCall(`/contest/${contest_id}/update`, data)
    if(res.status === "success") {
        window.location.reload();
        return
    }
    bundled.apiToast(res)
}


var cm = CodeMirror.fromTextArea(document.getElementById("contestDesc"), {
    mode: {
        name: "gfm",
        gitHubSpice: false,
        emoji: false,
    },
});
cm.setSize(null, "100%");

async function updateContestDesc(e) {
    e.preventDefault()
    const rez = await bundled.postCall(`/contest/${contest_id}/update`, {description: cm.getValue()})
    bundled.apiToast(rez)
}

document.getElementById("contest_update_form").addEventListener("submit", updateContest)
document.getElementById("contest_description_form").addEventListener("submit", updateContestDesc)
</script>
<script>
async function deleteContest(e) {
    e.preventDefault();
    if (!(await bundled.confirm(bundled.getText("confirmContestDelete")))) {
        return
    }
    let res = await bundled.postCall(`/contest/${contest_id}/delete`, {})
    if (res.status === "success") {
        window.location.assign("/contests/");
        return
    }
    bundled.apiToast(res)
}
document.getElementById("deleteContestButton").addEventListener("click", deleteContest);
</script>
<script>
// Contest problems-specific stuff
async function updateContestProblems(e) {
    e.preventDefault();
    let data = {
        list: bundled.stringIntToNumber(document.getElementById("contest_list").value.split(',')),
    }
    let res = await bundled.bodyCall(`/contest/${contest_id}/update/problems`, data)
    if(res.status === "success") {
        window.location.reload();
        return
    }
    bundled.apiToast(res)
}
document.getElementById("contest_problems_form").addEventListener("submit", updateContestProblems)
</script>

<script>
// Contest access-specific stuff
async function addEditor() {
        const username = document.getElementById('userToAdd').value;
        let res = await bundled.postCall(`/contest/${contest_id}/update/addEditor`, { username: username })
        bundled.apiToast(res)
        await loadView();
    }

    async function addTester() {
        const username = document.getElementById('userToAdd').value;
        let res = await bundled.postCall(`/contest/${contest_id}/update/addTester`, { username: username })
        bundled.apiToast(res)
        await loadView();
    }

    async function stripAccess(id) {
        let res = await bundled.postCall(`/contest/${contest_id}/update/stripAccess`, { user_id: id })
        bundled.apiToast(res)
        await loadView();
    }

    async function loadContest() {
        const res = await bundled.getCall(`/contest/${contest_id}/`, {});
        if (res.status === "error") {
            bundled.apiToast(res)
            return
        }
        return res.data
    }

    async function loadUsers(users, id) {
        console.log(id, document.getElementById(id))
        //document.getElementById(id).innerHTML = `<div class="list-group-head">${bundled.getText("loading")}</div>`
        let outhtml = ""
        if (users.length == 0) {
            outhtml += `<div class="list-group-head">No users</div>`
        }
        for (let user of users) {
            outhtml += `
            <div class="list-group-item flex justify-between items-center">
                <a href="/profile/${user.name}">
                    <img class="rounded inline-block mr-2" src="/api/user/getGravatar?name=${user.name}&s=32" width="32" height="32" alt="Avatar"/>
                    ${user.name}
                </a>
                ${user.id != window.platform_info.user_id ? `<span style='cursor: pointer;' onclick='stripAccess(${user.id})'>X</span>` : ''}
            </div>`
        }
        document.getElementById(id).innerHTML = outhtml
    }

    async function loadView() {
        const data = await loadContest();
        loadUsers(data.editors, 'editors_list')
        loadUsers(data.testers, 'testers_list')
    }

    document.addEventListener("DOMContentLoaded", () => loadView());
</script>

{{ end }}