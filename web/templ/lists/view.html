{{ define "title" }} {{.ProblemList.Title}} {{ end }}

{{ define "head" }}
<link rel="canonical" href="{{printf `/problem_lists/%d` .ProblemList.ID | formatCanonical}}" />
{{ end }}

{{ define "content" }}

{{ $user := .Ctx.User.Brief }}

{{ with pblistParent .ProblemList }}

<a class="block mb-2" href="/problem_lists/{{.ID}}"><i class="fas fa-arrow-left"></i> {{.Title}}</a>

{{ end }}

{{ with .ProblemList }}
    <div class="list-group mb-4">
        {{ template "problemlist_show" (genPblistParams authedUser . true)}}
    </div>
	{{ if $user }}
	{{ if or (eq $user.ID .AuthorID) $user.Admin }}
	<form id="pblist-update" class="segment-container" autocomplete="off">
		<h1> {{getText "list.update"}} </h1>
        <label class="block my-2">
            <span class="form-label">{{getText "title"}}: </span>
            <input type="text" id="pblist-title" class="form-input" value="{{.Title}}">
        </label>
        <label class="block my-2">
            <span class="form-label">{{getText "sublist_label"}}:</span>
            <input type="text" id="pblist-sublists" class="form-input" pattern="([0-9]+,?)+" value="{{intList (shallowPblistIDs .SubLists)}}">
        </label>
        <label class="block my-2">
            <span class="form-label">{{getText "pbs"}}:</span>
            <input type="text" id="pblist-list" class="form-input" pattern="([0-9]+,?)+" value="{{intList .List}}">
        </label>
        <div class="block my-2">
            <label class="inline-flex items-center text-lg">
                <input class="form-checkbox" name="sidebar_hidable" id="sidebar_hidable" type="checkbox" {{if .SidebarHidable}}checked{{end}}>
                <span class="ml-2">{{getText "sidebar_hidable"}}</span>
            </label>
        </div>
        <label class="block my-2 mb-4">
            <span class="form-label">{{getText "desc"}}: </span>
            <textarea id="desc_tarea" class="hidden">{{- .Description -}}</textarea>
        </label>
		<button class="btn btn-blue mr-2" type="submit">{{getText "button.update"}}</button>
        <button id="delButton" class="btn btn-red">{{getText "button.delete"}}</button>
	</form>

{{if authedUser.Admin}}
    <div class="my-2">
        <button id="visibleButton" class="btn btn-blue mr-2">{{getText "makeProblemsVisible"}}</button>
        <button id="invisibleButton" class="btn btn-blue mr-2">{{getText "makeProblemsHidden"}}</button>
    </div>
<script>
let problemIDs = {{.List}};

// TODO: Maybe make a popup with a progress bar?
async function makeProblemsVisible(e) {
    e.preventDefault();
    let promises = [];
    for(let pb of problemIDs) {
        promises.push((async (pbID) => {
            let res = await bundled.postCall(`/problem/${pbID}/update/`, {visible: true})
            if(res.status === "error") {
                bundled.apiToast(res)
                throw Error(res.data)
            }
        })(pb))
    }
    let rez = await Promise.allSettled(promises);
    for(let p of rez) {
        if(p.status === "rejected") {
            bundled.apiToast({status: "error", data: "Failed to make all problems visible"});
            return
        }
    }
    window.location.reload();
}

async function makeProblemsHidden(e) {
    e.preventDefault();
    let promises = [];
    for(let pb of problemIDs) {
        promises.push((async (pbID) => {
            let res = await bundled.postCall(`/problem/${pbID}/update/`, {visible: false})
            if(res.status === "error") {
                bundled.apiToast(res)
                throw Error(res.data)
            }
        })(pb))
    }
    let rez = await Promise.allSettled(promises);
    for(let p of rez) {
        if(p.status === "rejected") {
            bundled.apiToast({status: "error", data: "Failed to make all problems hidden"});
            return
        }
    }
    window.location.reload();
}

document.getElementById("visibleButton").addEventListener("click", makeProblemsVisible);
document.getElementById("invisibleButton").addEventListener("click", makeProblemsHidden);
</script>
{{ end }}
<script>
let problemListID = {{.ID}};
var cm = CodeMirror.fromTextArea(document.getElementById("desc_tarea"), {
	mode: {
		name: "gfm",
		gitHubSpice: false,
		emoji: false,
	}
});
cm.setSize(null, "100%");

async function updateProblemList(e) {
	e.preventDefault();
	let data = {
		id: problemListID,
		title: document.getElementById("pblist-title").value,
		description: cm.getValue(),
		list: bundled.stringIntToNumber(document.getElementById("pblist-list").value.split(',')),
        sublists: bundled.stringIntToNumber(document.getElementById("pblist-sublists").value.split(',')),
        sidebar_hidable: document.getElementById("sidebar_hidable").checked,
    };
	let res = await bundled.bodyCall("/problemList/update", data)
	if(res.status === "success") {
		window.location.reload();
		return
	}
	bundled.apiToast(res)
}
async function deleteProblemList(e) {
    e.preventDefault();
    if(!confirm(bundled.getText("pblistDeleteConfirm"))) {
        return
    }
    let data = {
        id: problemListID
    }
    let res = await bundled.postCall("/problemList/delete", data)
    if(res.status === "success") {
        window.location.assign("/problem_lists");
        return
    }
    bundled.apiToast(res);
}
document.getElementById("pblist-update").addEventListener("submit", updateProblemList)
document.getElementById("delButton").addEventListener("click", deleteProblemList);
</script>
	{{ end }}
	{{ end }}
{{ end }}


{{ end }}
