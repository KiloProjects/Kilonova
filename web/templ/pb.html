{{ define "title" }} {{getText .Ctx.Language "problem" .Problem.ID .Problem.Name}} {{ end }}
{{ define "content" }}

<h1 class="mt-4">{{getText .Ctx.Language "problemSingle"}} <code>{{.Problem.Name}}</code>
{{- if .ProblemEditor -}}
	<a href="/problems/{{- .Problem.ID -}}/edit"> {{getText .Ctx.Language "edit"}}</a>	
{{- end -}}
</h1>
<hr/>

<div class="mb-12">
	
	<div class="flex flex-wrap lg:border-b lg:border-gray-200">
		<div class="reset-list w-full my-6 lg:flex-1 lg:pr-2">
			{{if ispdflink .Problem.Description}}
				<p><a target='_blank' href='{{.Problem.Description}}'>{{.Problem.Description}}</a></p> <embed class='mx-2 my-2' type='application/pdf' src='{{.Problem.Description}}' width='95%' height='500px'>
			{{else}}
				{{.Markdown}}
			{{end}}
		</div>

		</script>
		<div class="w-full lg:w-3/12 lg:border-l lg:border-gray-200">
			<div class="lg:mt-6 lg:pl-4 pl-2 pb-3 font-semibold">
				<h2 class="text-xl">{{getText .Ctx.Language "generalInfo"}}</h2>
				<p>{{getText .Ctx.Language "id"}}: {{.Problem.ID}}</p>
				<p>{{getText .Ctx.Language "uploader"}}: {{.Author.Name}}</p>
				<p>{{getText .Ctx.Language "input"}}: {{if .Problem.ConsoleInput}}{{getText .Ctx.Language "console"}}{{else}}{{.Problem.TestName}}.in/{{.Problem.TestName}}.out{{end}}</p>
				<p>{{getText .Ctx.Language "memoryLimit"}}: {{KBtoMB .Problem.MemoryLimit}}MB</p>
				<p>{{getText .Ctx.Language "timeLimit"}}: {{.Problem.TimeLimit}}s</p>
				{{ if .ProblemEditor }}
				<p>{{getText .Ctx.Language "visibility"}}: 
				{{if .Problem.Visible}}
					<span class="badge-md bg-green-700">{{getText .Ctx.Language "published"}}</span>
				{{else}}
					<span class="badge-md bg-red-700">{{getText .Ctx.Language "unpublished"}}</span>
				{{end}}
				</p>
				{{end}}
				{{- if .Problem.AuthorCredits -}}
					<p>{{getText .Ctx.Language "author"}}: {{.Problem.AuthorCredits}}</p>
				{{- end -}}
				{{- if .Problem.SourceCredits -}}
					<p>{{getText .Ctx.Language "source"}}: {{.Problem.SourceCredits}}</p>
				{{- end -}}
				{{- if gt .Problem.DefaultPoints 0 -}}
					<p>{{getText .Ctx.Language "defaultPoints"}}: {{.Problem.DefaultPoints}}p</p>
				{{- end -}}
				<p><a href="/submissions/?problem_id={{.Problem.ID}}">{{getText .Ctx.Language "submissions"}}</a></p>
			</div>
			{{ if .Ctx.User }}
				<kn-pb-sidebar pbid="{{.Problem.ID}}"></kn-pb-sidebar>
			{{ end }}
			{{ $pbid := .Problem.ID }}
			{{ $ctx := .Ctx }}
			{{ with .Attachments }}
				<div class="h-0 w-full border-t border-gray-200"></div>
				<div class="mt lg:pl-2 lg:pb-2"> <!-- Attachments -->
					<div class="px-2">
						<p class="text-lg">{{getText $ctx.Language "attachments"}}</p>
						<p>{{getText $ctx.Language "attachmentPretty"}}</p>
						{{ range . }}
							<p class="segment-container"><a style="word-wrap: break-word;" href="/problems/{{$pbid}}/attachments/{{.Name}}">{{.Name}}</a></p>
						{{ end }}
					</div>
				</div>
			{{ end }}
		</div>

	</div>

<script>
let loadingIDs = new Map();
function makeSubWaiter(id) {
	if(loadingIDs.has(id)) {
		return `Will not watch ${id}`
	}
	loadingIDs.set(id, "reserved")
	let interv = setInterval(async () => {
		let res = await bundled.getCall("/submissions/getByID", {id: id})
		if(res.status == "error") {
			console.error(res);
			return
		}
		var lastStatus = loadingIDs.get(id);
		if(res.data.sub.status !== lastStatus) {
			document.dispatchEvent(new Event("kn-poll"))
		}
		if(res.data.sub.status == "finished") {
			bundled.createToast({title: bundled.getText("finishedEval"), description: bundled.getText("finalScore", id, res.data.sub.score), status: "success"})
			clearInterval(interv);
		}
		loadingIDs.set(id, res.data.sub.status)
	}, 2000)
	return `Watching ${id}...`
}
</script>

	{{ if .Ctx.User }}

	<h1 class="mt-4">{{getText .Ctx.Language "uploadSub"}}</h1>
		<label class="block mb-2">
			<span class="form-label">{{getText .Ctx.Language "language"}}:</span>
			<select id="sub_language" class="form-select">
				{{ range $name, $lang := .Languages }}
					{{ if not $lang.Disabled }}
					<option value="{{$name}}" {{if eq $name "cpp"}}selected{{end}}>{{$lang.PrintableName}}</option>
					{{ end }}
				{{ end }}
			</select>
		</label>

		<textarea id="SubArea" style="display: none;"></textarea>
		<button class="btn btn-blue mt-2" onclick="sendSub()">{{getText .Ctx.Language "send"}}</button>
		<script>
var cm = CodeMirror.fromTextArea(document.getElementById("SubArea"), {
	mode: bundled.languages["cpp"],
});

document.getElementById("sub_language").addEventListener("change", (e) => {
	let lang = bundled.languages[e.target.value]
	if(lang !== null) {
		cm.setOption("mode", lang)
	}
})

async function sendSub() {
	let sendData = {
		problemID: "{{ .Problem.ID }}",
		lang: document.getElementById("sub_language").value,
		code: cm.getValue(),
	};
	
	let res = await bundled.postCall("/submissions/submit", sendData)
	if(res.status == "error") {
		bundled.apiToast(res)
		return
	}
	bundled.createToast({title: bundled.getText("uploaded"), description: `<a href="/submissions/${res.data}">${bundled.getText("view")}</a>`})
	console.log(res.data, makeSubWaiter(res.data));
	document.dispatchEvent(new Event("kn-poll"));
}
		</script>
	{{ end }}

</div>
{{ end }} 
